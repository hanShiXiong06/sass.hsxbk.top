import{_ as e,g as t,aA as a,h as l,o as r,c as s,w as i,b as o,y as d,f as n,U as c,V as u,ad as m,W as x,z as f,D as p,i as h,ac as v,d as _,r as g,p as b,l as y,bh as w,q as k,bi as D,u as A,n as $,a as T,ab as S,C,aO as j,F as E,E as M,a7 as F,t as V,B as N,bl as O,b$ as Q,bF as H}from"./index-71c7df08.js";import{_ as q}from"./pay.6aa36878.js";import{_ as z}from"./loading-page.vue_vue_type_script_setup_true_lang.c7dc2256.js";import{b as B}from"./technician.707f779e.js";import{o as I,a as P}from"./order.7a0e41bc.js";import{d as U}from"./goods.5a980fee.js";import{f as Y}from"./cloneDeep.77735539.js";import"./pay.4cfa8889.js";function G(e){return e<10?`0${e}`:e}function J(){const e=new Date,t=e.getFullYear(),a=e.getMonth()+1,l=e.getDate(),r=t+"-"+G(a)+"-"+G(l),s=G(a)+"-"+G(l),i=G(a)+"月"+G(l)+"日",o=e.getHours(),d=e.getMinutes(),n=e.getSeconds(),c=Math.floor(Date.now()/1e3);return{y:t,md:i,mdTime:s,date:r,time:G(o)+":"+G(d)+":"+G(n),seconTime:c}}function R(e,t){const a=new Date(e),l=a.getFullYear(),r=a.getMonth()+1,s=a.getDate(),i=a.getDay(),o=a.getHours(),d=a.getMinutes();return{allDate:`${l}/${G(r)}/${G(s)}`,date:`${G(l)}-${G(r)}-${G(s)}`,md:`${G(r)}月${G(s)}日`,mdTime:`${G(r)}-${G(s)}`,day:`周${["日","一","二","三","四","五","六"][i]}`,dayNum:`${[7,1,2,3,4,5,6][i]}`,hour:G(o)+":"+G(d)+(t?"":":00")}}function W(e){let t=Math.floor(e/3600),a=Math.floor(e/60)-60*t,l=e%60;return t=t<10?"0"+t:t,a=a<10?"0"+a:a,l=l<10?"0"+l:l,t+":"+a+":"+l}function K(e){const t=e.split(":");return 60*t[0]*60+60*t[1]+Number(t[2])}const L=e({name:"times",model:{prop:"showPop",event:"change"},props:{rules:{type:Object,default:()=>({})},isQuantum:{type:Boolean,default:!1}},data:()=>({orderDateTime:"",orderDateStamp:"",dateArr:[],timeArr:[],nowDate:"",dateActive:0,timeActive:0,selectDate:"",show:!1}),created(){this.nowDate=J().md,this.initOnload()},methods:{initOnload(){let e=function(){const e=[],t=(new Date).getTime();let a=864e5,l={0:"今天",1:"明天",2:"后天"};for(let r=0;r<10;r++)e.push({date:R(t+a*r).date,mdTime:R(t+a*r).md,md:l[r]?l[r]:R(t+a*r).md,timeStamp:t+a*r,week:R(t+a*r).day,dayNum:R(t+a*r).dayNum,disable:!1});return e}();this.timeArr=function(e="10:00:00",t="21:00:00",a=1,l=!1){const r=[],s=R(Date.now()).allDate,i=`${s} ${t}`,o=new Date(`${s} ${e}`).getTime(),d=new Date(i).getTime(),n=36e5*a,c=(d-o)/n,u=c%2==0?c:c-1;let m=0;for(let x=o;x<=d;x+=n)if(l?(m++,r.push({begin:R(x,l).hour,end:R(x+n,l).hour,disable:!1})):r.push({time:R(x).hour,disable:!1}),l&&m>=u)return r;return r}(W(this.rules.start),W(this.rules.end),Number(this.rules.interval)/60,this.isQuantum);let t=Math.floor(K(J().time))+60*parseFloat(this.rules.advance)*60;this.dateArr=[],e.forEach(((e,a)=>{-1!=this.rules.week.indexOf(e.dayNum)&&(e.children=Y(this.timeArr),e.children.forEach(((a,l)=>{e.mdTime==this.nowDate&&t>`${K(a.begin+":00")}`&&delete e.children[l]})),e.children=e.children.filter((e=>""!==e)),this.dateArr.push(e))}));let a=!0;this.dateArr.forEach(((e,t)=>{e.children.forEach(((l,r)=>{!l.disable&&a&&(a=!1,this.timeActive=r,this.dateActive=t,this.selectDate=this.dateArr[t].mdTime,this.orderDateStamp=this.dateArr[t].date,this.orderDateTime=`${this.selectDate} ${e.children[this.timeActive].begin}-${e.children[this.timeActive].end}`,this.$emit("change",this.orderDateTime),this.$emit("getStamp",this.orderDateStamp))}))}))},selectDateEvent(e,t){this.dateActive=e,this.selectDate=t.mdTime,this.orderDateStamp=t.date,this.timeActive=0,this.orderDateTime=`${this.selectDate} ${t.children[this.timeActive].begin}-${t.children[this.timeActive].end}`,this.$emit("change",this.orderDateTime),this.$emit("getStamp",this.orderDateStamp)},selectTimeEvent(e,t){this.handleSelectQuantum(e,t),this.show=!1,this.$emit("change",this.orderDateTime)},handleSelectQuantum(e,t){this.timeActive=e,this.orderDateTime=`${this.selectDate} ${t.begin}-${t.end}`}}},[["render",function(e,_,g,b,y,w){const k=p,D=h,A=v,$=t(l("u-popup"),a);return r(),s($,{show:y.show,mode:"bottom",round:10,closeable:"",onClose:_[0]||(_[0]=e=>y.show=!1)},{default:i((()=>[o(D,{class:"box h-[728rpx]"},{default:i((()=>[o(D,{class:"title px-[30rpx] box-border text-center text-[28rpx] font-bold h-[90rpx] leading-[90rpx] border-0 border-solid border-[#f7f4f4] border-b-[2rpx]"},{default:i((()=>[o(k,null,{default:i((()=>[d("请选择上门时间")])),_:1})])),_:1}),y.dateArr.length?(r(),s(D,{key:0,class:"body flex h-[calc(100%-90rpx)] box-border"},{default:i((()=>[n(" 左侧日期选择 "),o(A,{"scroll-y":!0,class:"left bg-[#f8f8f8] shrink-0 w-[230rpx]","scroll-with-animation":"","scroll-into-view":"id"+(y.dateActive?y.dateActive-1:0)},{default:i((()=>[(r(!0),c(u,null,m(y.dateArr,((e,t)=>(r(),c(u,{key:t},[e.children.length>0?(r(),s(D,{key:0,class:x(["date-box flex px-[30rpx] py-[16rpx] box-border text-[24rpx] items-center",{"bg-[#fff]":t==y.dateActive}]),id:"id"+t,onClick:a=>w.selectDateEvent(t,e)},{default:i((()=>[o(D,{class:"text-[24rpx] leading-[58rpx]"},{default:i((()=>[d(f(e.md),1)])),_:2},1024),o(D,{class:"text-[24rpx] leading-[58rpx]"},{default:i((()=>[d("("+f(e.week)+")",1)])),_:2},1024)])),_:2},1032,["id","onClick","class"])):n("v-if",!0)],64)))),128))])),_:1},8,["scroll-into-view"]),n(" 右侧时间选择 "),o(A,{"scroll-y":!0,class:"right w-[calc(100%-230rpx)] px-[30rpx] box-border","scroll-with-animation":"","scroll-into-view":"id"+(y.timeActive?y.timeActive-1:0)},{default:i((()=>[n(" 时间选项 "),(r(!0),c(u,null,m(y.dateArr[y.dateActive].children,((e,t)=>(r(),c(u,{key:t},[e.disable?n("v-if",!0):(r(),s(D,{key:0,class:x(["h-[72rpx] flex border-0 border-solid border-b-[2rpx] border-[#eee] justify-between items-center",{"text-[var(--primary-color)]":t==y.timeActive}]),onClick:a=>w.selectTimeEvent(t,e),id:"id"+t},{default:i((()=>[o(D,{class:x(["text-[24rpx]",{"text-[var(--primary-color)]":t==y.timeActive}])},{default:i((()=>[o(k,null,{default:i((()=>[d(f(e.begin)+"-"+f(e.end),1)])),_:2},1024)])),_:2},1032,["class"]),t==y.timeActive?(r(),s(k,{key:0,class:"nc-iconfont nc-icon-duihaoV6mm mr-[30rpx] text-[38rpx]"})):n("v-if",!0)])),_:2},1032,["onClick","class","id"]))],64)))),128))])),_:1},8,["scroll-into-view"])])),_:1})):n("v-if",!0)])),_:1})])),_:1},8,["show"])}]]),X=e(_({__name:"payment",setup(e){const a=g(!1),x=g([[]]),v=g(!1),_=g({}),G=g(null),J=g(!1),R=g({order_key:"",technician_id:"",technician_name:"默认分配",reserve_service_time:"",reserve_service_time_stamp:"",member_remark:"",delivery:{take_address_id:""}});uni.getStorageSync("o2oCreateData")&&Object.assign(R.value,uni.getStorageSync("o2oCreateData"));const W=g("");b((e=>{W.value=e.id,K(e.id),X()}));const K=e=>{a.value=!0,B(e).then((e=>{x.value[0].push({label:"默认分配",id:""}),e.data.forEach(((e,t)=>{let l={};l.label=e.name,l.id=e.id,x.value[0].push(l),a.value=!1}))})).catch((()=>{a.value=!1}))},X=()=>{U().then((e=>{_.value=e.data}))},Z=e=>{R.value.technician_id=e.value[0].id,R.value.technician_name=e.value[0].label,v.value=!1},ee=uni.getStorageSync("selectAddressCallback");ee&&(R.value.delivery.take_address_id=ee.address_id,uni.removeStorage({key:"selectAddressCallback"}));const te=()=>{uni.setStorage({key:"selectAddressCallback",data:{back:`/addon/o2o/pages/order/payment?id=${W.value}`},success(){T({url:"/addon/o2o/pages/address/index"})}})};(()=>{let e=Y(R.value);e.sku=JSON.stringify(e.sku),a.value=!0,I(e).then((e=>{G.value=e.data,R.value.order_key=e.data.order_key,a.value=!1})).catch((()=>{a.value=!1}))})();let ae=0;const le=g(null),re=()=>{if(!G.value.delivery.take_address&&(V({title:"请选择上门地址",icon:"none"}),1)||!R.value.reserve_service_time&&(V({title:"请选择上门时间",icon:"none"}),1)||J.value)return;J.value=!0;let e=Y(R.value);P(e).then((({data:e})=>{var t;ae=e.order_id,0==G.value.basic.order_money?T({url:"/addon/o2o/pages/order/detail",param:{order_id:ae},mode:"redirectTo"}):null==(t=le.value)||t.open(e.trade_type,e.order_id,`/addon/o2o/pages/order/detail?order_id=${e.order_id}`)})).catch((()=>{J.value=!1}))},se=g(null),ie=()=>{se.value.show=!0},oe=e=>{R.value.reserve_service_time=e},de=e=>{R.value.reserve_service_time_stamp=new Date(e).getTime()/1e3},ne=()=>{T({url:"/addon/o2o/pages/order/detail",param:{order_id:ae},mode:"redirectTo"})},ce=y(),{query:ue}=w(location.href);return ue.code&&k()&&D({code:ue.code}).then((e=>{ce.getMemberInfo()})),(e,g)=>{const b=p,y=h,w=N,k=t(l("u--image"),O),D=t(l("u-picker"),Q),T=S,V=C,B=t(l("u-tabbar"),H),I=t(l("pay"),q),P=t(l("loading-page"),z);return r(),s(y,{style:$(e.themeColor())},{default:i((()=>[!a.value&&G.value?(r(),s(y,{key:0,class:"bg-[#F6F8FA] min-h-screen overflow-hidden py-[20rpx] px-[24rpx]"},{default:i((()=>[n(" 上门地址 "),o(y,{class:"flex items-center py-[24rpx] px-[24rpx] bg-[#fff] rounded",onClick:te},{default:i((()=>[o(y,{class:"flex-1 w-0"},{default:i((()=>[e.$u.test.isEmpty(G.value.delivery.take_address)?(r(),s(y,{key:1,class:"text-[26rpx]"},{default:i((()=>[d(f(A(E)("addHomeAddress")),1)])),_:1})):(r(),s(y,{key:0},{default:i((()=>[o(y,{class:"font-500 text-[30rpx] mb-[10rpx]"},{default:i((()=>[d(f(G.value.delivery.take_address.name)+" ",1),o(b,{class:"text-[30rpx]"},{default:i((()=>[d(f(A(j)(G.value.delivery.take_address.mobile)),1)])),_:1})])),_:1}),o(y,{class:"text-[26rpx] text-gray-subtitle mt-[10rpx] leading-[40rpx] line-feed"},{default:i((()=>[d(f(G.value.delivery.take_address.full_address),1)])),_:1})])),_:1}))])),_:1}),o(b,{class:"nc-iconfont nc-icon-youV6xx text-[26rpx] text-[var(--text-color-light6)]"})])),_:1}),(r(!0),c(u,null,m(G.value.goods_data,((e,t)=>(r(),s(y,{class:"outline-border"},{default:i((()=>[o(k,{width:"168rpx",height:"168rpx",src:A(M)(e.sku_image),model:"aspectFill"},{error:i((()=>[o(w,{class:"w-[168rpx] h-[168rpx]",src:A(M)("static/resource/images/diy/shop_default.jpg"),mode:"aspectFill"},null,8,["src"])])),_:2},1032,["src"]),o(y,{class:"flex flex-col py-1 flex-1 ml-[10rpx]"},{default:i((()=>[o(y,{class:"text-ellipsis text-[#333] text-[26rpx] leading-normal font-500"},{default:i((()=>[d(f(e.goods.goods_name),1)])),_:2},1024),o(y,{class:"flex justify-between mt-auto"},{default:i((()=>[o(y,{class:"text-[var(--price-text-color)] font-500 price-font"},{default:i((()=>[o(b,{class:"text-xs"},{default:i((()=>[d("￥")])),_:1}),o(b,null,{default:i((()=>[d(f(A(F)(e.price)),1)])),_:2},1024)])),_:2},1024),o(y,{class:"font-500 text-sm"},{default:i((()=>[o(b,{class:"text-[26rpx]"},{default:i((()=>[d("x")])),_:1}),d(f(e.num),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),256)),o(y,{class:"bg-[#fff] mt-4 p-3 rounded-lg"},{default:i((()=>[n(" 预约技师 "),o(y,{class:"flex justify-between items-center box-border py-[24rpx]"},{default:i((()=>[o(y,{class:"flex-align"},{default:i((()=>[o(b,{class:"text-[28rpx] text-[#4D4D4D] font-bold nc-iconfont nc-icon-qiuzhirenyuanV6xx1"}),o(b,{class:"text-[28rpx] ml-2"},{default:i((()=>[d(f(A(E)("selectiveTechnician")),1)])),_:1})])),_:1}),o(y,{class:"flex-align text-[#63676D]",onClick:g[0]||(g[0]=e=>v.value=!0)},{default:i((()=>[o(y,{class:"text-[28rpx] ml-2 text-right"},{default:i((()=>[d(f(R.value.technician_name?R.value.technician_name:A(E)("selectiveTechnician")),1)])),_:1}),o(b,{class:"text-[26rpx] text-[var(--text-color-light6)] nc-iconfont nc-icon-youV6xx"})])),_:1})])),_:1}),o(D,{show:v.value,columns:x.value,keyName:"label",onConfirm:Z,onCancel:g[1]||(g[1]=e=>v.value=!1)},null,8,["show","columns"]),n(" 预约时间 "),o(y,{class:"flex justify-between items-center box-border py-[24rpx]"},{default:i((()=>[o(y,{class:"flex-align"},{default:i((()=>[o(b,{class:"text-[28rpx] text-[#4D4D4D] font-bold nc-iconfont nc-icon-a-shijianV6xx-36"}),o(b,{class:"text-[28rpx] ml-2"},{default:i((()=>[d(f(A(E)("addHomeTime")),1)])),_:1})])),_:1}),o(y,{class:"flex-align text-[#63676D]",onClick:ie},{default:i((()=>[o(y,{class:"text-[28rpx] ml-2 text-right"},{default:i((()=>[d(f(R.value.reserve_service_time?R.value.reserve_service_time:A(E)("selectAddTimePlaceholder")),1)])),_:1}),o(b,{class:"text-[26rpx] text-[var(--text-color-light6)] nc-iconfont nc-icon-youV6xx"})])),_:1})])),_:1}),Object.keys(_.value).length?(r(),s(A(L),{key:0,ref_key:"selectTime",ref:se,rules:_.value,isQuantum:!0,onChange:oe,onGetStamp:de},null,8,["rules"])):n("v-if",!0),n(" 备注 "),o(y,{class:"flex justify-between items-center box-border py-[24rpx]"},{default:i((()=>[o(b,{class:"text-[28rpx]"},{default:i((()=>[d(f(A(E)("buysMessage")),1)])),_:1}),o(y,{class:"flex-align text-[#63676D]"},{default:i((()=>[o(T,{class:"uni-input text-[28rpx] ml-2 text-right",placeholder:A(E)("messagePlaceholder"),modelValue:R.value.member_remark,"onUpdate:modelValue":g[2]||(g[2]=e=>R.value.member_remark=e)},null,8,["placeholder","modelValue"])])),_:1})])),_:1})])),_:1}),o(y,{class:"mt-[20rpx] p-[24rpx] rounded-md bg-white"},{default:i((()=>[o(y,{class:"flex font-500 py-[10rpx]"},{default:i((()=>[o(y,{class:"text-[28rpx] w-[150rpx]"},{default:i((()=>[d(f(A(E)("goodsMoney")),1)])),_:1}),o(y,{class:"flex-1 w-0 text-right text-[var(--price-text-color)] price-font"},{default:i((()=>[o(b,{class:"text-[24rpx]"},{default:i((()=>[d("￥")])),_:1}),o(b,null,{default:i((()=>[d(f(A(F)(G.value.basic.goods_money)),1)])),_:1})])),_:1})])),_:1})])),_:1}),o(y,{class:"h-[148rpx] w-screen"}),o(B,{fixed:!0,placeholder:!0,safeAreaInsetBottom:!0},{default:i((()=>[o(y,{class:"flex-1 flex items-center justify-between"},{default:i((()=>[o(y,{class:"whitespace-nowrap px-[30rpx] text-color font-600 leading-[45rpx]"},{default:i((()=>[o(b,{class:"text-[#333333] text-[26rpx]"},{default:i((()=>[d(f(A(E)("total")),1)])),_:1}),o(b,{class:"text-[24rpx] font-500 text-[var(--price-text-color)] price-font"},{default:i((()=>[d("￥")])),_:1}),o(b,{class:"text-[34rpx] mr-[10rpx] font-500 text-[var(--price-text-color)] price-font"},{default:i((()=>[d(f(A(F)(G.value.basic.order_money)),1)])),_:1})])),_:1}),o(V,{class:"!px-[40rpx] !h-[60rpx] text-[28rpx] mr-[30rpx] leading-[60rpx] rounded-full text-white bg-[var(--primary-color)]",onClick:re},{default:i((()=>[d(f(A(E)("submit")),1)])),_:1})])),_:1})])),_:1}),o(I,{ref_key:"payRef",ref:le,onClose:ne},null,512)])),_:1})):n("v-if",!0),o(P,{loading:a.value},null,8,["loading"])])),_:1},8,["style"])}}}),[["__scopeId","data-v-f14b39a3"]]);export{X as default};
