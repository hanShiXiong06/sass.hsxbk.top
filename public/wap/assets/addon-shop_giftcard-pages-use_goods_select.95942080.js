import{d as e,r as a,N as t,j as l,p as s,t as r,a as u,s as d,H as o,x as n,o as c,c as i,w as x,U as f,b as p,y as _,f as m,V as v,z as g,u as k,ad as b,W as y,n as h,D as j,i as w,C,g as F,h as I,E as V,A as E,B as O,ab as z,_ as B}from"./index-71c7df08.js";import{_ as D}from"./loading-page.vue_vue_type_script_setup_true_lang.c7dc2256.js";import{e as U,u as G}from"./card.1368a464.js";const L=B(e({__name:"use_goods_select",setup(e){const B=a({}),L=a(!0),T=a(!1),A=t({card_id:"",sku_data:[]}),H=a({}),N=l((()=>{let e=0;return Object.values(H.value).forEach((a=>{e+=parseInt(a.num||0)})),e}));s((e=>{if(e.card_id){if(!d())return o().setLoginBack({url:"/addon/shop_giftcard/pages/use_goods_select",param:{card_id:e.card_id}}),!1;A.card_id=e.card_id,W(e.card_id)}else r({title:"礼品卡不存在",icon:"none"}),setTimeout((()=>{u({url:"/addon/shop_giftcard/pages/index",mode:"reLaunch"})}),600)})),n((()=>{Object.keys(B.value).length&&W(B.value.card_id)}));const S=a(!1),W=e=>{L.value=!0,H.value={},U(e).then((e=>{B.value=e.data,S.value=!1,e.data.cardGoods.forEach((e=>{let a=0;a="diy"==B.value.giftcard.card_goods_type?B.value.total_num-B.value.use_num:e.total_num-e.use_num,H.value[e.sku_id]={sku_id:e.sku_id,max_num:a>e.stock?parseInt(e.stock):a,stock:e.stock,num:0},S.value||e.status&&e.stock||(S.value=!0)})),L.value=!1}))},q=(e,a)=>{"jia"==a?H.value[e].num=parseInt(H.value[e].num)+1:"jian"==a&&(H.value[e].num=parseInt(H.value[e].num)-1),""!==H.value[e].num&&null!=H.value[e].num||(H.value[e].num=0),H.value[e].num<0&&(H.value[e].num=0),H.value[e].num>H.value[e].max_num&&(H.value[e].num=parseInt(H.value[e].max_num)),"diy"==B.value.giftcard.card_goods_type&&(()=>{for(let e in H.value){let a=B.value.total_num-B.value.use_num,t=0;Object.values(H.value).forEach((e=>{t+=parseInt(e.num||0)})),a-=t-H.value[e].num,H.value[e].max_num=a>H.value[e].stock?parseInt(H.value[e].stock):a}})()},J=()=>{u({url:"/addon/shop_giftcard/pages/my_card_list",mode:"redirectTo"})},K=()=>{T.value||(N.value?"diy"==B.value.giftcard.card_goods_type&&"all"==B.value.giftcard.delivery_way&&N.value<B.value.total_num-B.value.use_num?r({title:"该礼品卡必须全部提货",icon:"none"}):(T.value=!0,A.sku_data=Object.values(H.value).map((e=>({sku_id:e.sku_id,num:e.num}))).filter((e=>e.num)),G(A).then((e=>{T.value=!1,e.data&&uni.setStorage({key:"orderCreateData",data:e.data,success:()=>{u({url:"/addon/shop/pages/order/payment"})}})})).catch((()=>{T.value=!1}))):r({title:"请选择需要兑换的商品",icon:"none"}))};return(e,a)=>{const t=j,l=w,s=O,r=z,u=C,d=F(I("loading-page"),D);return c(),i(l,{class:"bg-[#f8f8f8] min-h-[100vh]",style:h(e.themeColor())},{default:x((()=>[Object.keys(B.value).length&&Object.keys(H.value).length?(c(),f(v,{key:0},[S.value?(c(),i(l,{key:0,class:"h-[66rpx] bg-[#FCF2DF] flex items-center px-[var(--sidebar-m)]"},{default:x((()=>[p(t,{class:"iconfont iconshengyinpc !text-[26rpx]"}),p(t,{class:"text-[24rpx] leading-[34rpx] ml-[16rpx] font-400"},{default:x((()=>[_("以下商品存在已售罄或已下架的商品，请耐心等待卖家备货")])),_:1})])),_:1})):m("v-if",!0),p(l,{class:"px-[var(--sidebar-m)] py-[var(--top-m)]"},{default:x((()=>[p(l,{class:"card-template"},{default:x((()=>[p(l,{class:"flex items-center justify-between pb-[20rpx] border-0 !border-b-[2rpx] border-solid border-[#f8f8f8]"},{default:x((()=>["diy"==B.value.giftcard.card_goods_type?(c(),f(v,{key:0},[p(t,{class:"title !mb-0"},{default:x((()=>[_("请在以下商品中任选"+g(B.value.total_num-B.value.use_num)+"件商品",1)])),_:1}),p(l,{class:"text-[30rpx] text-[var(--text-color-light6)]"},{default:x((()=>[p(t,{class:"!text-[var(--primary-color)]"},{default:x((()=>[_(g(k(N)),1)])),_:1}),p(t,null,{default:x((()=>[_("/"+g(B.value.total_num-B.value.use_num),1)])),_:1})])),_:1})],64)):(c(),i(t,{key:1,class:"title !mb-0"},{default:x((()=>[_("请兑换以下商品")])),_:1}))])),_:1}),(c(!0),f(v,null,b(B.value.cardGoods,((e,a)=>(c(),i(l,{key:e.sku_id,class:"mt-[var(--pad-top-m)] flex"},{default:x((()=>[p(l,{class:"w-[210rpx] h-[210rpx] rounded-[var(--rounded-mid)] relative"},{default:x((()=>[e.sku_image?(c(),i(s,{key:0,class:"w-[210rpx] h-[210rpx] rounded-[var(--rounded-mid)]",src:k(V)(e.sku_image),onError:a=>e.sku_image="static/resource/images/diy/shop_default.jpg",mode:"aspectFill"},null,8,["src","onError"])):(c(),i(s,{key:1,class:"w-[210rpx] h-[210rpx] rounded-[var(--rounded-mid)]",src:k(V)("static/resource/images/diy/shop_default.jpg"),mode:"aspectFill"},null,8,["src"])),e.stock?e.status?m("v-if",!0):(c(),i(l,{key:3,class:"absolute w-full w-[210rpx] h-[210rpx] bg-[rgba(51,51,51,0.6)] z-10 left-0 top-0 rounded-[var(--rounded-mid)]"},{default:x((()=>[p(l,{class:"text-[#fff] leading-[210rpx] text-center text-[24rpx] font-500"},{default:x((()=>[_("该商品已下架")])),_:1})])),_:1})):(c(),i(l,{key:2,class:"absolute w-full w-[210rpx] h-[210rpx] bg-[rgba(51,51,51,0.6)] z-10 left-0 top-0 rounded-[var(--rounded-mid)]"},{default:x((()=>[p(l,{class:"text-[#fff] leading-[210rpx] text-center text-[24rpx] font-500"},{default:x((()=>[_("该商品已售罄")])),_:1})])),_:1}))])),_:2},1024),p(l,{class:"ml-[20rpx] flex-1 flex flex-col justify-between"},{default:x((()=>[p(l,{class:"w-full"},{default:x((()=>[p(l,{class:"max-w-[432rpx] text-[28rpx] leading-[40rpx] font-400 truncate text-[#303133]"},{default:x((()=>[_(g(e.goods_name),1)])),_:2},1024),p(l,{class:"mt-[20rpx] text-[24rpx] text-[var(--text-color-light6)] font-400 truncate leading-[34rpx] max-w-[432rpx]"},{default:x((()=>[_(g(e.sku_name),1)])),_:2},1024),"all"==B.value.giftcard.card_goods_type?(c(),i(l,{key:0,class:"mt-[20rpx] text-[24rpx] text-[var(--text-color-light6)] font-400 truncate leading-[34rpx] max-w-[432rpx]"},{default:x((()=>[_("最多可选"+g(e.total_num)+"件 已兑换"+g(e.use_num)+"件",1)])),_:2},1024)):m("v-if",!0)])),_:2},1024),p(l,{class:"flex items-center justify-between h-[52rpx]"},{default:x((()=>[p(l,{class:"text-[var(--price-text-color)] flex items-baseline"},{default:x((()=>[p(t,{class:"text-[22rpx] price-font"},{default:x((()=>[_("￥")])),_:1}),p(t,{class:"text-[36rpx] font-500 price-font"},{default:x((()=>[_(g(parseFloat(e.price).toFixed(2).split(".")[0]),1)])),_:2},1024),p(t,{class:"text-[22rpx] font-500 price-font"},{default:x((()=>[_("."+g(parseFloat(e.price).toFixed(2).split(".")[1]),1)])),_:2},1024)])),_:2},1024),H.value[e.sku_id].max_num?(c(),i(l,{key:0,class:"flex items-center h-[52rpx]"},{default:x((()=>[p(t,{onClick:E((a=>q(e.sku_id,"jian")),["stop"]),class:y(["text-[24rpx] font-500 nc-iconfont nc-icon-jianV6xx leading-[52rpx]",{"text-[var(--text-color-light9)]":!H.value[e.sku_id].num}])},null,8,["onClick","class"]),p(r,{class:"text-[#303133] text-[28rpx] mx-[10rpx] w-[80rpx] h-[44rpx] bg-[var(--temp-bg)] leading-[44rpx] text-center rounded-[6rpx]",type:"number",onBlur:a=>q(e.sku_id,""),modelValue:H.value[e.sku_id].num,"onUpdate:modelValue":a=>H.value[e.sku_id].num=a},null,8,["onBlur","modelValue","onUpdate:modelValue"]),p(t,{onClick:E((a=>q(e.sku_id,"jia")),["stop"]),class:y(["text-[24rpx] font-500 nc-iconfont nc-icon-jiahaoV6xx leading-[52rpx]",{"text-[var(--text-color-light9)]":H.value[e.sku_id].num==H.value[e.sku_id].max_num}])},null,8,["onClick","class"])])),_:2},1024)):m("v-if",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),p(l,{class:"tab-bar-placeholder"}),p(l,{class:"border-[0] border-t-[2rpx] border-solid border-[#f5f5f5] w-[100%] flex justify-between pl-[30rpx] pr-[20rpx] bg-[#fff] box-border fixed left-0 bottom-0 tab-bar z-1 items-center"},{default:x((()=>[p(l,{class:"flex flex-shrink-0 items-center mr-[30rpx]"},{default:x((()=>[p(l,{class:"flex flex-col justify-center items-center",onClick:J},{default:x((()=>[p(l,{class:"iconfont nc-icon-kabao text-[36rpx]"}),p(t,{class:"text-[20rpx] mt-[10rpx]"},{default:x((()=>[_("卡包")])),_:1})])),_:1})])),_:1}),p(l,{class:"flex flex-1 items-center"},{default:x((()=>["to_use"==B.value.status||"can_use"==B.value.status?(c(),i(u,{key:0,class:y(["w-full !h-[70rpx] font-500 text-[26rpx] !text-[#fff] primary-btn-bg !m-0 leading-[70rpx] rounded-full remove-border",{"opacity-40":T.value}]),onClick:K},{default:x((()=>[_("确认兑换")])),_:1},8,["class"])):m("v-if",!0),"used"==B.value.status?(c(),i(u,{key:1,class:"w-full !h-[70rpx] font-500 text-[26rpx] !text-[#fff] !bg-[var(--text-color-light9)] !m-0 leading-[70rpx] rounded-full remove-border"},{default:x((()=>[_("已使用")])),_:1})):m("v-if",!0),"invalid"==B.value.status?(c(),i(u,{key:2,class:"w-full !h-[70rpx] font-500 text-[26rpx] !text-[#fff] !bg-[var(--text-color-light9)] !m-0 leading-[70rpx] rounded-full remove-border"},{default:x((()=>[_("已失效")])),_:1})):m("v-if",!0)])),_:1})])),_:1})],64)):m("v-if",!0),p(d,{loading:L.value},null,8,["loading"])])),_:1},8,["style"])}}}),[["__scopeId","data-v-70a3c3be"]]);export{L as default};
