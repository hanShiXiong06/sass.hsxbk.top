import{x as Be,f as He,r as R,n as m,a$ as J,l as Je,q as n,U as f,ap as le,a3 as z,aI as K,H as pe}from"./index-6f32d09b.js";import{S as ze}from"./sortable.esm-be94e56d.js";import{b as Ke,g as Ue,V as We,W as Qe,a3 as Xe,a4 as Ye,a5 as et,j as tt}from"./goods-8f7103ad.js";import{j as st}from"./poster-11e724dc.js";import{r as rt}from"./range-2967ecbd.js";function dt(b={}){const _e=Be(),N=He(),D=R(!1),i=m({goods_id:"",goods_type:"real",goods_name:"",sub_title:"",goods_image:"",goods_category:"",brand_id:"",poster_id:"",label_ids:[],service_ids:[],supplier_id:"",status:"1",sort:"",addon_shop_supplier:[],spec_type:"single",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",unit:"",virtual_sale_num:"",member_discount:"",attr_format:[],attr_id:"",goods_desc:""});Object.assign(i,b.formData),i.goods_id=R(_e.query.goods_id);const ue=b.appendFormData;Object.assign(i,ue);const k=b.appendRefreshGoodsSkuData||{},U=b.appendSingleGoodsData,W=b.getFormRules,w=m({}),O=b.getFormRef,A=m([]);J(()=>{let e=O();for(let r in e)w[r]=e[r];b.getVerify&&A.splice(0,A.length,...b.getVerify())});const de=b.editApi,fe=b.addApi,P=R("basic"),ge=(e,r)=>{},Q=m([]),he=e=>{N.push(e.path)};Ke().then(e=>{const r=e.data;if(r)for(const t in r)Q.push(r[t])});const C=m([]),me={multiple:!0},ve=e=>{},ke=()=>{const e=N.resolve({path:"/shop/goods/category"});window.open(e.href)},X=(e=!1)=>{Ue().then(r=>{const t=r.data;if(t){const s=[];t.forEach(c=>{const o=[];c.child_list&&c.child_list.forEach(p=>{o.push({value:p.category_id,label:p.category_name})}),s.push({value:c.category_id,label:c.category_name,children:o})}),C.splice(0,C.length,...s),e&&f({message:n("refreshSuccess"),type:"success"})}})};X();const $=m([]),ye=()=>{const e=N.resolve({path:"/shop/goods/brand"});window.open(e.href)},Y=(e=!1)=>{We({}).then(r=>{const t=r.data;t&&($.splice(0,$.length,...t),e&&f({message:n("refreshSuccess"),type:"success"}))})};Y();const j=m([]),be=()=>{const e=N.resolve({path:"/poster/list"});window.open(e.href)},ee=(e=!1)=>{st({type:"shop_goods"}).then(r=>{const t=r.data;t&&(j.splice(0,j.length,...t),e&&f({message:n("refreshSuccess"),type:"success"}))})};ee();const G=m([]),Ne=()=>{const e=N.resolve({path:"/shop/goods/label"});window.open(e.href)},te=()=>{Qe({}).then(e=>{const r=e.data;r&&G.splice(0,G.length,...r)})};te();const L=m([]),we=()=>{const e=N.resolve({path:"/shop/goods/service"});window.open(e.href)},se=()=>{Xe({}).then(e=>{const r=e.data;r&&L.splice(0,L.length,...r)})};se();const F=m([]),Se=()=>{const e=N.resolve({path:"/shop_supplier/supplier"});window.open(e.href)},re=()=>{Ye({}).then(e=>{const r=e.data;r&&F.splice(0,F.length,...r)})},d=m([]),l=m({}),I=m([]),oe=R(0),S=()=>oe.value>0,Ee=e=>{if(i.addon_shop_supplier=e.addon_shop_supplier,i.addon_shop_supplier&&i.addon_shop_supplier.status==1&&re(),i.goods_id&&e.goods_info){if(oe.value=e.goods_info.active_goods_count,i.goods_name=e.goods_info.goods_name,i.sub_title=e.goods_info.sub_title,i.goods_type=e.goods_info.goods_type,i.goods_image=e.goods_info.goods_image,i.goods_category=e.goods_info.goods_category,i.brand_id=e.goods_info.brand_id,i.poster_id=e.goods_info.poster_id,i.label_ids=e.goods_info.label_ids,i.service_ids=e.goods_info.service_ids,i.supplier_id=e.goods_info.supplier_id,i.status=e.goods_info.status,i.sort=e.goods_info.sort,i.attr_format=e.goods_info.attr_format?JSON.parse(e.goods_info.attr_format):[],i.attr_id=e.goods_info.attr_id,M.value=!0,ce(i.attr_id||-1),i.spec_type=e.goods_info.spec_type,i.stock=e.goods_info.stock,i.spec_type=="single"){const r=e.goods_info.sku_list[0];i.price=r.price,i.market_price=r.market_price,i.cost_price=r.cost_price,i.sku_no=r.sku_no,U&&Object.assign(i,U(r))}else if(i.spec_type=="multi"){e.goods_info.spec_list.forEach(s=>{const c=[];s.spec_values=s.spec_values.split(","),s.spec_values.forEach(o=>{c.push({id:E(),spec_value_name:o})}),d.push({id:E(),spec_id:s.spec_id,goods_id:s.goods_id,spec_name:s.spec_name,values:c})}),T();const t=e.goods_info.sku_list;for(let s in l)for(let c=0;c<t.length;c++){let o=t[c];if(l[s].spec_name==o.sku_spec_format.replace(/,/g," ")){l[s].sku_id=o.sku_id,l[s].sku_image=o.sku_image,l[s].price=o.price,l[s].market_price=o.market_price,l[s].cost_price=o.cost_price;for(let p in k)l[s][p]=o[p];l[s].stock=o.stock,l[s].sku_id=o.sku_id,l[s].sku_no=o.sku_no,l[s].is_default=o.is_default;break}}J(()=>{x(),ie()})}i.member_discount=e.goods_info.member_discount,i.unit=e.goods_info.unit,i.virtual_sale_num=e.goods_info.virtual_sale_num,i.goods_desc=e.goods_info.goods_desc}},ie=()=>{if(!S()&&O().specValueRef)for(let e=0;e<O().specValueRef.length;e++){const r=O().specValueRef[e],t=ze.create(r,{group:"draggable-element-"+e,animation:200,onEnd:s=>{const c=d[e].values[s.oldIndex];d[e].values.splice(s.oldIndex,1),d[e].values.splice(s.newIndex,0,c),J(()=>{t.sort(rt(d[e].values.length).map(o=>o.toString())),T(),x()})}})}},E=(e=5)=>Number(Math.random().toString().substr(3,e)+Date.now()).toString(36),Te=()=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}if(d.length>4){f({type:"warning",message:`${n("maxAddSpecTips")}`});return}d.push({id:E(),spec_name:"",values:[{id:E(),spec_value_name:""}]})},xe=e=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d.splice(e,1),T(),x(),V()},Re=e=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d[e].values.push({id:E(),spec_value_name:""}),ie()},De=le(e=>{T(),x()}),Oe=(e,r)=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d[e].values.splice(r,1),T(),x(),V()},Pe=(e,r)=>{for(const t in l)t==r?l[t].is_default=e:l[t].is_default=0},V=le(()=>{let e=0;for(const r in l)l[r].stock&&(e+=parseInt(l[r].stock));i.stock=e}),T=()=>{const e=d,r=z(l);let t={},s=0;for(const o of e){let p={};if(Object.keys(t).length>0)for(const u in t)for(let _ of o.values){let v=z(t[u].sku_spec);v.push(_),p["sku_"+s]={spec_name:`${t[u].spec_name} ${_.spec_value_name}`,sku_spec:v,sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let h in k)p["sku_"+s][h]=k[h].value;s++}else for(let u of o.values){let _=u.spec_value_name;p["sku_"+s]={spec_name:_,sku_spec:[u],sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let v in k)p["sku_"+s][v]=k[v].value;s++}t=Object.keys(p).length>0?p:t}for(const o in r)for(const p in t)if(Ae(r[o].sku_spec,t[p].sku_spec)===t[p].sku_spec.length){const _=t[p].spec_name,v=t[p].sku_spec;Object.assign(t[p],r[o]),t[p].spec_name=_,t[p].sku_spec=v;break}for(const o in l)delete l[o];let c="";for(const o in t)c==""?(c=o,t[o].is_default=1):t[o].is_default=0,l[o]=t[o]},Ae=(e,r)=>{let t=0;for(let s=0;s<e.length;s++)for(let c=0;c<r.length;c++)if(e[s].id===r[c].id){t++;break}return t},x=()=>{let e=0;for(let s=0;s<d.length;s++)d[s].spec_name!=""&&d[s].values.length>0&&e++;let r=1;const t=[];for(let s=e-1;s>=0;s--){for(let c=0;c<Object.keys(l).length;)if(d[s].values.length>0)for(let o of d[s].values)t.push({index:c,colSpan:s,rowSpan:r,spec_value_name:o.spec_value_name}),c=c+r;else c++;r=r*d[s].values.length}t.reverse(),I.splice(0,I.length,...t)},a=m({spec:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:""});var ae={};for(let e in k)ae[e]=k[e].value;Object.assign(a,ae);const Ce=()=>{if(a.price&&(isNaN(a.price)||!g.digit.test(a.price))){f({type:"warning",message:`${n("priceTips")}`});return}if(a.market_price&&(isNaN(a.market_price)||!g.digit.test(a.market_price))){f({type:"warning",message:`${n("marketPriceTips")}`});return}if(a.cost_price&&(isNaN(a.cost_price)||!g.digit.test(a.cost_price))){f({type:"warning",message:`${n("costPriceTips")}`});return}if(a.stock&&(isNaN(a.stock)||!g.number.test(a.stock))){f({type:"warning",message:`${n("stockTips")}`});return}for(let e in k){let r=g[k[e].regExp],t=k[e].message;if(a[e]&&(isNaN(a[e])||!r.test(a[e]))){f({type:"warning",message:t});return}}if(a.spec){a.price&&(l[a.spec].price=a.price),a.market_price&&(l[a.spec].market_price=a.market_price),a.cost_price&&(l[a.spec].cost_price=a.cost_price),a.stock&&(l[a.spec].stock=a.stock);for(let e in k)a[e]&&(l[a.spec][e]=a[e]);a.sku_no&&(l[a.spec].sku_no=a.sku_no)}else for(const e in l){a.price&&(l[e].price=a.price),a.market_price&&(l[e].market_price=a.market_price),a.cost_price&&(l[e].cost_price=a.cost_price),a.stock&&(l[e].stock=a.stock);for(let r in k)a[r]&&(l[e][r]=a[r]);a.sku_no&&(l[e].sku_no=a.sku_no)}a.price="",a.market_price="",a.cost_price="",a.stock="",a.sku_no="";for(let e in k)a[e]=""},g={required:/[\S]+/,number:/^\d{0,10}$/,digit:/^\d{0,10}(.?\d{0,2})$/,special:/^\d{0,10}(.?\d{0,3})$/},$e=Je(()=>{let e={goods_name:[{required:!0,trigger:"blur",validator:(r,t,s)=>{t===""&&s(new Error(n("goodsNamePlaceholder"))),t.length>60?s(new Error(n("goodsNameMaxLengthTips"))):s()}}],sub_title:[{trigger:"blur",validator:(r,t,s)=>{t.length>80?s(new Error(n("subTitleMaxLengthTips"))):s()}}],goods_image:[{required:!0,message:n("goodsImagePlaceholder"),trigger:"blur"}],goods_category:[{required:!0,message:n("goodsCategoryPlaceholder"),trigger:"blur"}],sort:[{trigger:"blur",validator:(r,t,s)=>{isNaN(t)||!g.number.test(t)?s(new Error(n("sortTips"))):s()}}],price:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="single"?t===""?s(new Error(n("pricePlaceholder"))):isNaN(t)||!g.digit.test(t)?s(new Error(n("priceTips"))):t<0?s(new Error(n("priceNotZeroTips"))):s():s()}}],market_price:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="single"?isNaN(t)||!g.digit.test(t)?s(new Error(n("marketPriceTips"))):t<0?s(new Error(n("marketPriceNotZeroTips"))):s():s()}}],cost_price:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="single"?isNaN(t)||!g.digit.test(t)?s(new Error(n("costPriceTips"))):t<0?s(new Error(n("costPriceNotZeroTips"))):s():s()}}],stock:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="single"?t===""?s(new Error(n("stockPlaceholder"))):isNaN(t)||!g.number.test(t)?s(new Error(n("stockTips"))):t<0?s(new Error(n("stockNotZeroTips"))):s():s()}}],virtual_sale_num:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="single"?isNaN(t)||!g.number.test(t)?s(new Error(n("virtualSaleNumTips"))):t<0?s(new Error(n("virtualSaleNumNotZeroTips"))):s():s()}}],spec_type:[{trigger:"blur",validator:(r,t,s)=>{i.spec_type=="multi"&&Object.keys(l).length==0&&s(new Error(n("pleaseEditSpecPlaceholder"))),s()}}],goods_desc:[{required:!0,trigger:["blur","change"],validator:(r,t,s)=>{if(t==="")s(new Error(n("goodsDescPlaceholder")));else{if(t.length<5||t.length>5e4)return s(new Error(n("goodsDescMaxTips"))),!1;s()}}}]};return W&&Object.assign(e,W(i,g)),e}),je=()=>[{trigger:"blur",validator:(e,r,t)=>{i.spec_type=="multi"?r.length==0?t(n("pricePlaceholder")):isNaN(r)||!g.digit.test(r)?t(n("priceTips")):r<0?t(n("priceNotZeroTips")):t():t()}}],Ge=()=>[{trigger:"blur",validator:(e,r,t)=>{i.spec_type=="multi"?isNaN(r)||!g.digit.test(r)?t(n("marketPriceTips")):r<0?t(n("marketPriceNotZeroTips")):t():t()}}],Le=()=>[{trigger:"blur",validator:(e,r,t)=>{i.spec_type=="multi"?isNaN(r)||!g.digit.test(r)?t(n("costPriceTips")):r<0?t(n("costPriceNotZeroTips")):t():t()}}],Fe=()=>[{trigger:"blur",validator:(e,r,t)=>{i.spec_type=="multi"?r.length==0?t(n("stockPlaceholder")):isNaN(r)||!g.number.test(r)?t(n("stockTips")):r<0?t(n("stockNotZeroTips")):t():t()}}],Ie=e=>{let r=[{key:"basic",verify:!1,ref:w.basicFormRef},{key:"price_stock",verify:!1,ref:w.priceStockFormRef},{key:"price_stock",verify:!1,ref:w.skuFormRef}];r=r.concat(A);let t={key:"detail",verify:!1,ref:w.detailFormRef};if(r.push(t),r.forEach((s,c)=>{s.ref.validate(o=>{s.verify=o})}),i.spec_type=="multi"){let s=!0,c=[],o=[];for(let u=0;u<d.length;u++){const _=d[u];if(pe.require(_.spec_name)){s=!1,f({type:"warning",message:`${n("specNameRequire")}`});break}if(c.indexOf(_.spec_name)>-1){s=!1,f({type:"warning",message:`${n("specNameRepeat")}`});break}else c.push(_.spec_name);if(_.values.length)for(let v=0;v<_.values.length;v++){const h=_.values[v];if(pe.require(h.spec_value_name)){s=!1,f({type:"warning",message:`${n("specValueRequire")}`});break}if(o.indexOf(h.spec_value_name)>-1){s=!1,f({type:"warning",message:`${n("specValueNameRepeat")}`});break}else o.push(h.spec_value_name)}else s=!1,f({type:"warning",message:`${n("specValueRequire")}`});if(!s)break}if(!s){P.value="price_stock";return}let p=!1;for(const u in l)l[u].is_default&&(p=!0);if(!p){P.value="price_stock",f({type:"warning",message:`${n("lackDefaultSpec")}`});return}}setTimeout(()=>{let s=!0;for(let c=0;c<r.length;c++)if(r[c].verify==!1){P.value=r[c].key,s=!1;break}s&&e&&e()},10)},Ve=(e=null)=>{Ie(()=>{if(D.value)return;D.value=!0;const r=i.goods_id?de:fe,t=z(i);if(t.spec_type=="multi"){t.stock=0;for(const o in l)l[o].stock&&(t.stock+=parseInt(l[o].stock))}const s=[];t.goods_category.forEach(o=>{typeof o=="object"?o.forEach(p=>{s.indexOf(p)==-1&&s.push(p)}):s.indexOf(o)==-1&&s.push(o)}),t.goods_category=s,t.goods_sku_data=l,t.goods_spec_format=d,t.attr_format=[],K(y).forEach((o,p)=>{if(o.attr_value_name&&o.select_child_val||o.attr_value_id>0){let u={};u.attr_value_id=o.attr_value_id,u.attr_value_name=o.attr_value_name,u.type=o.type,u.sort=o.sort,u.attr_child_value_id=o.select_child_name,u.attr_child_value_name=o.select_child_val,t.attr_format.push(u)}}),t.attr_format.sort((o,p)=>p.sort-o.sort),t.attr_format=JSON.stringify(t.attr_format),e&&Object.assign(t,e(t)),r(t).then(o=>{D.value=!1,N.push("/shop/goods/list")}).catch(()=>{D.value=!1})})},qe=()=>{N.push("/shop/goods/list")},Ze=e=>{e.target.value=e.target.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g,""),e.target.value=e.target.value.replace(/[`~!@#$%^&*()_\-+=<>?:"{}|,.\/;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]/g,"")},Me=e=>{var r;(r=w.detailFormRef.value)==null||r.validateField("goods_desc")},q=m([]),ne=()=>{et({}).then(e=>{q.splice(0,q.length,...e.data)})};ne();let Z=!1;const y=m([]),M=R(!1),ce=(e=0)=>{if(Z||!e)return!1;Z=!0;let r=e==-1?0:e;tt(r).then(t=>{let s=Object.keys(t.data).length&&t.data.attr_value_format?JSON.parse(t.data.attr_value_format):[],c=K(y);if(c=c.filter(o=>o.attr_value_id<=0),s.filter(o=>{o.select_child_name=o.type=="checkbox"?[]:"",o.select_child_val=o.type=="checkbox"?[]:""}),c=c.concat(s),y.splice(0,y.length,...c),Z=!1,M.value){let o=i.attr_format.map(_=>_.attr_value_id),p=K(y);p=p.filter(_=>o.indexOf(_.attr_value_id)>-1),i.attr_format.forEach((_,v)=>{p.forEach((h,B,H)=>{h.attr_value_id==_.attr_value_id&&(H[B].select_child_name=_.attr_child_value_id,H[B].select_child_val=_.attr_child_value_name,H[B].sort=_.sort)})});let u=p.map(_=>_.attr_value_id);i.attr_format.forEach((_,v)=>{if(u.indexOf(_.attr_value_id)==-1&&_.type=="text"){let h={};h.attr_value_id=_.attr_value_id,h.attr_value_name=_.attr_value_name,h.sort=_.sort,h.type="text",h.select_child_name=_.attr_child_value_id,h.select_child_val=_.attr_child_value_name,p.push(h)}}),p.sort((_,v)=>v.sort-_.sort),y.splice(0,y.length,...p),M.value=!1}})};return{formData:i,activeName:P,tabHandleClick:ge,goodsType:Q,changeGoodsType:he,goodsCategoryOptions:C,goodsCategoryProps:me,categoryHandleChange:ve,toGoodsCategoryEvent:ke,refreshGoodsCategory:X,brandOptions:$,toGoodsBrandEvent:ye,refreshGoodsBrand:Y,posterOptions:j,toPosterEvent:be,refreshGoodsPoster:ee,labelOptions:G,toGoodsLabelEvent:Ne,refreshGoodsLabel:te,serviceOptions:L,toGoodsServiceEvent:we,refreshGoodsService:se,supplierOptions:F,toSupplierEvent:Se,refreshSupplier:re,goodsSpecFormat:d,goodsSkuData:l,specData:I,generateRandom:E,isDisabledPrice:S,addSpec:Te,deleteSpec:xe,addSpecValue:Re,specValueNameInputListener:De,deleteSpecValue:Oe,specValueIsDefaultChangeListener:Pe,specStockSum:V,batchOperation:a,saveBatch:Ce,regExp:g,formRules:$e,skuPriceRules:je,skuMarketPriceRules:Ge,skuCostPriceRules:Le,skuStockRules:Fe,handleGoodsInit:Ee,save:Ve,back:qe,filterSpecial:Ze,handleBlur:Me,attrOptions:q,attrChange:ce,getAttrListFn:ne,attrTableData:y,addAttr:()=>{let e={attr_value_id:"",attr_value_name:"",child:{id:1,name:""},sort:"",type:"text",select_child_name:"",select_child_val:""};e.attr_value_id=-Math.floor(new Date().getSeconds()+Math.floor(new Date().getMilliseconds())),e.sort=y.length+1,y.push(e)},delAttr:e=>{y.splice(e,1)},attrRadioChange:(e,r)=>{y.forEach((t,s,c)=>(t.type=="radio"&&t.child.forEach((o,p)=>{o.id==r&&(c[s].select_child_name=o.id,c[s].select_child_val=o.name)}),t))},attrCheckboxChange:(e,r)=>{y.forEach((t,s,c)=>{t.type=="checkbox"&&(c[s].select_child_val=[],t.child.forEach((o,p)=>{r.indexOf(o.id)>-1&&c[s].select_child_val.push(o.name)}))})}}}export{dt as u};
