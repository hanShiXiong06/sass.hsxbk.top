import{x as Je,f as ze,r as x,n as m,a$ as J,l as Ke,q as n,U as f,aq as ce,a3 as z,aJ as K,H as pe}from"./index-99f00cf3.js";import{S as Ue}from"./sortable.esm-be94e56d.js";import{b as Qe,g as We,a1 as Xe,a2 as Ye,ab as es,ac as ss,ad as ts,j as rs}from"./goods-4a8ebb3e.js";import{j as os}from"./poster-a2e7062d.js";import{r as is}from"./range-463f6550.js";function gs(b={}){const _e=Je(),N=ze(),O=x(!1),i=m({goods_id:"",goods_type:"real",goods_name:"",sub_title:"",goods_image:"",goods_video:"",goods_category:"",brand_id:"",poster_id:"",label_ids:[],service_ids:[],supplier_id:"",status:"1",sort:"",addon_shop_supplier:[],spec_type:"single",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",unit:"",virtual_sale_num:"",member_discount:"",is_limit:0,limit_type:1,max_buy:"",min_buy:"",attr_format:[],attr_id:"",goods_desc:"",skuCheckAll:!1,skuIsIndeterminate:!1,skuCheckedCities:[]});Object.assign(i,b.formData),i.goods_id=x(_e.query.goods_id);const ue=b.appendFormData;Object.assign(i,ue);const y=b.appendRefreshGoodsSkuData||{},U=b.appendSingleGoodsData,Q=b.getFormRules,w=m({}),R=b.getFormRef,P=m([]);J(()=>{let e=R();for(let r in e)w[r]=e[r];b.getVerify&&P.splice(0,P.length,...b.getVerify())});const de=b.editApi,fe=b.addApi,D=x("basic"),ge=(e,r)=>{},W=m([]),he=e=>{N.push(e.path)};Qe().then(e=>{const r=e.data;if(r)for(const s in r)W.push(r[s])});const A=m([]),me={multiple:!0},ke=e=>{},ve=()=>{const e=N.resolve({path:"/shop/goods/category"});window.open(e.href)},X=(e=!1)=>{We().then(r=>{const s=r.data;if(s){const t=[];s.forEach(a=>{const o=[];a.child_list&&a.child_list.forEach(c=>{o.push({value:c.category_id,label:c.category_name})}),t.push({value:a.category_id,label:a.category_name,children:o})}),A.splice(0,A.length,...t),e&&f({message:n("refreshSuccess"),type:"success"})}})};X();const j=m([]),ye=()=>{const e=N.resolve({path:"/shop/goods/brand"});window.open(e.href)},Y=(e=!1)=>{Xe({}).then(r=>{const s=r.data;s&&(j.splice(0,j.length,...s),e&&f({message:n("refreshSuccess"),type:"success"}))})};Y();const $=m([]),be=()=>{const e=N.resolve({path:"/poster/list"});window.open(e.href)},ee=(e=!1)=>{os({type:"shop_goods"}).then(r=>{const s=r.data;s&&($.splice(0,$.length,...s),e&&f({message:n("refreshSuccess"),type:"success"}))})};ee();const I=m([]),Ne=()=>{const e=N.resolve({path:"/shop/goods/label"});window.open(e.href)},se=()=>{Ye({}).then(e=>{const r=e.data;r&&I.splice(0,I.length,...r)})};se();const G=m([]),we=()=>{const e=N.resolve({path:"/shop/goods/service"});window.open(e.href)},te=()=>{es({}).then(e=>{const r=e.data;r&&G.splice(0,G.length,...r)})};te();const F=m([]),Se=()=>{const e=N.resolve({path:"/shop_supplier/supplier"});window.open(e.href)},re=()=>{ss({}).then(e=>{const r=e.data;r&&F.splice(0,F.length,...r)})},d=m([]),l=m({}),L=m([]),oe=x(0),S=()=>oe.value>0,Ee=e=>{if(i.addon_shop_supplier=e.addon_shop_supplier,i.addon_shop_supplier&&i.addon_shop_supplier.status==1&&re(),i.goods_id&&e.goods_info){if(oe.value=e.goods_info.active_goods_count,i.goods_name=e.goods_info.goods_name,i.sub_title=e.goods_info.sub_title,i.goods_type=e.goods_info.goods_type,i.goods_image=e.goods_info.goods_image,i.goods_video=e.goods_info.goods_video,i.goods_category=e.goods_info.goods_category,i.brand_id=e.goods_info.brand_id,i.poster_id=e.goods_info.poster_id,i.label_ids=e.goods_info.label_ids,i.service_ids=e.goods_info.service_ids,i.supplier_id=e.goods_info.supplier_id,i.status=e.goods_info.status,i.sort=e.goods_info.sort,i.attr_format=e.goods_info.attr_format?JSON.parse(e.goods_info.attr_format):[],i.attr_id=e.goods_info.attr_id,Z.value=!0,le(i.attr_id||-1),i.spec_type=e.goods_info.spec_type,i.stock=e.goods_info.stock,i.spec_type=="single"){const r=e.goods_info.sku_list[0];i.price=r.price,i.market_price=r.market_price,i.cost_price=r.cost_price,i.sku_no=r.sku_no,U&&Object.assign(i,U(r))}else if(i.spec_type=="multi"){e.goods_info.spec_list.forEach(t=>{const a=[];t.spec_values=t.spec_values.split(","),t.spec_values.forEach(o=>{a.push({id:E(),spec_value_name:o})}),d.push({id:E(),spec_id:t.spec_id,goods_id:t.goods_id,spec_name:t.spec_name,values:a})}),T();const s=e.goods_info.sku_list;for(let t in l)for(let a=0;a<s.length;a++){let o=s[a];if(l[t].spec_name==o.sku_spec_format.replace(/,/g," ")){l[t].sku_id=o.sku_id,l[t].sku_image=o.sku_image,l[t].price=o.price,l[t].market_price=o.market_price,l[t].cost_price=o.cost_price;for(let c in y)l[t][c]=o[c];l[t].stock=o.stock,l[t].sku_id=o.sku_id,l[t].sku_no=o.sku_no,l[t].is_default=o.is_default;break}}J(()=>{C(),ie()})}i.member_discount=e.goods_info.member_discount,i.unit=e.goods_info.unit,i.virtual_sale_num=e.goods_info.virtual_sale_num,i.is_limit=e.goods_info.is_limit,i.limit_type=e.goods_info.limit_type,i.max_buy=e.goods_info.max_buy,i.min_buy=e.goods_info.min_buy,i.goods_desc=e.goods_info.goods_desc}},ie=()=>{if(!S()&&R().specValueRef)for(let e=0;e<R().specValueRef.length;e++){const r=R().specValueRef[e],s=Ue.create(r,{group:"draggable-element-"+e,animation:200,onEnd:t=>{const a=d[e].values[t.oldIndex];d[e].values.splice(t.oldIndex,1),d[e].values.splice(t.newIndex,0,a),J(()=>{s.sort(is(d[e].values.length).map(o=>o.toString())),T(),C()})}})}},E=(e=5)=>Number(Math.random().toString().substr(3,e)+Date.now()).toString(36),Te=()=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}if(d.length>4){f({type:"warning",message:`${n("maxAddSpecTips")}`});return}d.push({id:E(),spec_name:"",values:[{id:E(),spec_value_name:""}]})},Ce=e=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d.splice(e,1),T(),C(),q()},xe=e=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d[e].values.push({id:E(),spec_value_name:""}),ie()},Oe=ce(e=>{T(),C()}),Re=(e,r)=>{if(S()){f({type:"warning",message:`${n("participateInActiveDisableTips")}`});return}d[e].values.splice(r,1),T(),C(),q()},De=(e,r)=>{for(const s in l)s==r?l[s].is_default=e:l[s].is_default=0},q=ce(()=>{let e=0;for(const r in l)l[r].stock&&(e+=parseInt(l[r].stock));i.stock=e}),T=()=>{const e=d,r=z(l);let s={},t=0;for(const o of e){let c={};if(Object.keys(s).length>0)for(const u in s)for(let _ of o.values){let v=z(s[u].sku_spec);v.push(_),c["sku_"+t]={spec_name:`${s[u].spec_name} ${_.spec_value_name}`,sku_spec:v,sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let h in y)c["sku_"+t][h]=y[h].value;t++}else for(let u of o.values){let _=u.spec_value_name;c["sku_"+t]={spec_name:_,sku_spec:[u],sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let v in y)c["sku_"+t][v]=y[v].value;t++}s=Object.keys(c).length>0?c:s}for(const o in r)for(const c in s)if(Pe(r[o].sku_spec,s[c].sku_spec)===s[c].sku_spec.length){const _=s[c].spec_name,v=s[c].sku_spec;Object.assign(s[c],r[o]),s[c].spec_name=_,s[c].sku_spec=v;break}for(const o in l)delete l[o];let a="";for(const o in s)a==""?(a=o,s[o].is_default=1):s[o].is_default=0,l[o]=s[o];i.skuCheckAll=!1,i.skuIsIndeterminate=!1,i.skuCheckedCities=[]},Pe=(e,r)=>{let s=0;for(let t=0;t<e.length;t++)for(let a=0;a<r.length;a++)if(e[t].id===r[a].id){s++;break}return s},C=()=>{let e=0;for(let t=0;t<d.length;t++)d[t].spec_name!=""&&d[t].values.length>0&&e++;let r=1;const s=[];for(let t=e-1;t>=0;t--){for(let a=0;a<Object.keys(l).length;)if(d[t].values.length>0)for(let o of d[t].values)s.push({index:a,colSpan:t,rowSpan:r,spec_value_name:o.spec_value_name}),a=a+r;else a++;r=r*d[t].values.length}s.reverse(),L.splice(0,L.length,...s)},p=m({spec:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:""});var ne={};for(let e in y)ne[e]=y[e].value;Object.assign(p,ne);const Ae=e=>{i.skuIsIndeterminate=!1,e?i.skuCheckedCities=Object.keys(l):i.skuCheckedCities=[]},je=e=>{const r=e.length;i.skuCheckAll=r===Object.keys(l).length,i.skuIsIndeterminate=r>0&&r<Object.keys(l).length},$e=()=>{if(i.skuCheckedCities.length==0){f({type:"warning",message:`${n("pleaseSelectSku")}`});return}if(p.price&&(isNaN(p.price)||!g.digit.test(p.price))){f({type:"warning",message:`${n("priceTips")}`});return}if(p.market_price&&(isNaN(p.market_price)||!g.digit.test(p.market_price))){f({type:"warning",message:`${n("marketPriceTips")}`});return}if(p.cost_price&&(isNaN(p.cost_price)||!g.digit.test(p.cost_price))){f({type:"warning",message:`${n("costPriceTips")}`});return}if(p.stock&&(isNaN(p.stock)||!g.number.test(p.stock))){f({type:"warning",message:`${n("stockTips")}`});return}for(let e in y){let r=g[y[e].regExp],s=y[e].message;if(p[e]&&(isNaN(p[e])||!r.test(p[e]))){f({type:"warning",message:s});return}}i.skuCheckedCities.forEach(e=>{p.price&&(l[e].price=p.price),p.market_price&&(l[e].market_price=p.market_price),p.cost_price&&(l[e].cost_price=p.cost_price),p.stock&&(l[e].stock=p.stock);for(let r in y)p[r]&&(l[e][r]=p[r]);p.sku_no&&(l[e].sku_no=p.sku_no)}),p.price="",p.market_price="",p.cost_price="",p.stock="",p.sku_no="";for(let e in y)p[e]=""},g={required:/[\S]+/,number:/^\d{0,10}$/,digit:/^\d{0,10}(.?\d{0,2})$/,special:/^\d{0,10}(.?\d{0,3})$/},Ie=Ke(()=>{let e={goods_name:[{required:!0,trigger:"blur",validator:(r,s,t)=>{s===""&&t(new Error(n("goodsNamePlaceholder"))),s.length>60?t(new Error(n("goodsNameMaxLengthTips"))):t()}}],sub_title:[{trigger:"blur",validator:(r,s,t)=>{s.length>80?t(new Error(n("subTitleMaxLengthTips"))):t()}}],goods_image:[{required:!0,message:n("goodsImagePlaceholder"),trigger:"blur"}],goods_category:[{required:!0,message:n("goodsCategoryPlaceholder"),trigger:"blur"}],sort:[{trigger:"blur",validator:(r,s,t)=>{isNaN(s)||!g.number.test(s)?t(new Error(n("sortTips"))):t()}}],price:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="single"?s===""?t(new Error(n("pricePlaceholder"))):isNaN(s)||!g.digit.test(s)?t(new Error(n("priceTips"))):s<0?t(new Error(n("priceNotZeroTips"))):t():t()}}],market_price:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.digit.test(s)?t(new Error(n("marketPriceTips"))):s<0?t(new Error(n("marketPriceNotZeroTips"))):t():t()}}],cost_price:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.digit.test(s)?t(new Error(n("costPriceTips"))):s<0?t(new Error(n("costPriceNotZeroTips"))):t():t()}}],stock:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="single"?s===""?t(new Error(n("stockPlaceholder"))):isNaN(s)||!g.number.test(s)?t(new Error(n("stockTips"))):s<0?t(new Error(n("stockNotZeroTips"))):t():t()}}],virtual_sale_num:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.number.test(s)?t(new Error(n("virtualSaleNumTips"))):s<0?t(new Error(n("virtualSaleNumNotZeroTips"))):t():t()}}],spec_type:[{trigger:"blur",validator:(r,s,t)=>{i.spec_type=="multi"&&Object.keys(l).length==0&&t(new Error(n("pleaseEditSpecPlaceholder"))),t()}}],max_buy:[{trigger:"blur",validator:(r,s,t)=>{s===""?t(new Error(n("maxBuyPlaceholder"))):isNaN(s)||!g.number.test(s)?t(new Error(n("maxBuyTips"))):s<1?t(new Error(n("maxBuyNotZeroTips"))):t()}}],min_buy:[{trigger:"blur",validator:(r,s,t)=>{isNaN(s)||!g.number.test(s)?t(new Error(n("minBuyFormatErrorTips"))):s<0?t(new Error(n("minBuyNotZeroTips"))):i.is_limit==1&&s>Number(i.max_buy)?t(new Error(n("minBuyGreaterThanMaxBuyTips"))):t()}}],goods_desc:[{required:!0,trigger:["blur","change"],validator:(r,s,t)=>{if(s==="")t(new Error(n("goodsDescPlaceholder")));else{if(s.length<5||s.length>5e4)return t(new Error(n("goodsDescMaxTips"))),!1;t()}}}]};return Q&&Object.assign(e,Q(i,g)),e}),Ge=()=>[{trigger:"blur",validator:(e,r,s)=>{i.spec_type=="multi"?r.length==0?s(n("pricePlaceholder")):isNaN(r)||!g.digit.test(r)?s(n("priceTips")):r<0?s(n("priceNotZeroTips")):s():s()}}],Fe=()=>[{trigger:"blur",validator:(e,r,s)=>{i.spec_type=="multi"?isNaN(r)||!g.digit.test(r)?s(n("marketPriceTips")):r<0?s(n("marketPriceNotZeroTips")):s():s()}}],Le=()=>[{trigger:"blur",validator:(e,r,s)=>{i.spec_type=="multi"?isNaN(r)||!g.digit.test(r)?s(n("costPriceTips")):r<0?s(n("costPriceNotZeroTips")):s():s()}}],qe=()=>[{trigger:"blur",validator:(e,r,s)=>{i.spec_type=="multi"?r.length==0?s(n("stockPlaceholder")):isNaN(r)||!g.number.test(r)?s(n("stockTips")):r<0?s(n("stockNotZeroTips")):s():s()}}],Be=e=>{let r=[{key:"basic",verify:!1,ref:w.basicFormRef},{key:"price_stock",verify:!1,ref:w.priceStockFormRef},{key:"price_stock",verify:!1,ref:w.skuFormRef},{key:"price_stock",verify:!1,ref:w.priceStockCommonFormRef}];r=r.concat(P);let s={key:"detail",verify:!1,ref:w.detailFormRef};if(r.push(s),r.forEach((t,a)=>{t.ref.validate(o=>{t.verify=o})}),i.spec_type=="multi"){let t=!0,a=[],o=[];for(let u=0;u<d.length;u++){const _=d[u];if(pe.require(_.spec_name)){t=!1,f({type:"warning",message:`${n("specNameRequire")}`});break}if(a.indexOf(_.spec_name)>-1){t=!1,f({type:"warning",message:`${n("specNameRepeat")}`});break}else a.push(_.spec_name);if(_.values.length)for(let v=0;v<_.values.length;v++){const h=_.values[v];if(pe.require(h.spec_value_name)){t=!1,f({type:"warning",message:`${n("specValueRequire")}`});break}if(o.indexOf(h.spec_value_name)>-1){t=!1,f({type:"warning",message:`${n("specValueNameRepeat")}`});break}else o.push(h.spec_value_name)}else t=!1,f({type:"warning",message:`${n("specValueRequire")}`});if(!t)break}if(!t){D.value="price_stock";return}let c=!1;for(const u in l)l[u].is_default&&(c=!0);if(!c){D.value="price_stock",f({type:"warning",message:`${n("lackDefaultSpec")}`});return}}setTimeout(()=>{let t=!0;for(let a=0;a<r.length;a++)if(r[a].verify==!1){D.value=r[a].key,t=!1;break}t&&e&&e()},10)},Ve=(e=null)=>{Be(()=>{if(O.value)return;O.value=!0;const r=i.goods_id?de:fe,s=z(i);if(s.spec_type=="multi"){s.stock=0;for(const o in l)l[o].stock&&(s.stock+=parseInt(l[o].stock))}const t=[];s.goods_category.forEach(o=>{typeof o=="object"?o.forEach(c=>{t.indexOf(c)==-1&&t.push(c)}):t.indexOf(o)==-1&&t.push(o)}),s.goods_category=t,s.goods_sku_data=l,s.goods_spec_format=d,s.attr_format=[],K(k).forEach((o,c)=>{if(o.attr_value_name&&o.select_child_val||o.attr_value_id>0){let u={};u.attr_value_id=o.attr_value_id,u.attr_value_name=o.attr_value_name,u.type=o.type,u.sort=o.sort,u.attr_child_value_id=o.select_child_name,u.attr_child_value_name=o.select_child_val,s.attr_format.push(u)}}),s.attr_format.sort((o,c)=>c.sort-o.sort),s.attr_format=JSON.stringify(s.attr_format),e&&Object.assign(s,e(s)),r(s).then(o=>{O.value=!1,N.push("/shop/goods/list")}).catch(()=>{O.value=!1})})},Ze=()=>{N.push("/shop/goods/list")},Me=e=>{e.target.value=e.target.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g,""),e.target.value=e.target.value.replace(/[`~!@#$%^&*()_\-+=<>?:"{}|,.\/;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]/g,"")},He=e=>{var r;(r=w.detailFormRef.value)==null||r.validateField("goods_desc")},B=m([]),ae=()=>{ts({}).then(e=>{B.splice(0,B.length,...e.data)})};ae();let V=!1;const k=m([]),Z=x(!1),le=(e=0)=>{if(V||!e)return!1;V=!0;let r=e==-1?0:e;rs(r).then(s=>{let t=Object.keys(s.data).length&&s.data.attr_value_format?JSON.parse(s.data.attr_value_format):[],a=K(k);if(a=a.filter(o=>o.attr_value_id<=0),t.filter(o=>{o.select_child_name=o.type=="checkbox"?[]:"",o.select_child_val=o.type=="checkbox"?[]:""}),a=a.concat(t),k.splice(0,k.length,...a),V=!1,Z.value){let o=i.attr_format.map(_=>_.attr_value_id),c=K(k);c=c.filter(_=>o.indexOf(_.attr_value_id)>-1),i.attr_format.forEach((_,v)=>{c.forEach((h,M,H)=>{h.attr_value_id==_.attr_value_id&&(H[M].select_child_name=_.attr_child_value_id,H[M].select_child_val=_.attr_child_value_name,H[M].sort=_.sort)})});let u=c.map(_=>_.attr_value_id);i.attr_format.forEach((_,v)=>{if(u.indexOf(_.attr_value_id)==-1&&_.type=="text"){let h={};h.attr_value_id=_.attr_value_id,h.attr_value_name=_.attr_value_name,h.sort=_.sort,h.type="text",h.select_child_name=_.attr_child_value_id,h.select_child_val=_.attr_child_value_name,c.push(h)}}),c.sort((_,v)=>v.sort-_.sort),k.splice(0,k.length,...c),Z.value=!1}})};return{formData:i,activeName:D,tabHandleClick:ge,goodsType:W,changeGoodsType:he,goodsCategoryOptions:A,goodsCategoryProps:me,categoryHandleChange:ke,toGoodsCategoryEvent:ve,refreshGoodsCategory:X,brandOptions:j,toGoodsBrandEvent:ye,refreshGoodsBrand:Y,posterOptions:$,toPosterEvent:be,refreshGoodsPoster:ee,labelOptions:I,toGoodsLabelEvent:Ne,refreshGoodsLabel:se,serviceOptions:G,toGoodsServiceEvent:we,refreshGoodsService:te,supplierOptions:F,toSupplierEvent:Se,refreshSupplier:re,goodsSpecFormat:d,goodsSkuData:l,specData:L,generateRandom:E,isDisabledPrice:S,addSpec:Te,deleteSpec:Ce,addSpecValue:xe,specValueNameInputListener:Oe,deleteSpecValue:Re,specValueIsDefaultChangeListener:De,specStockSum:q,batchOperation:p,skuHandleCheckAllChange:Ae,handleCheckedCitiesChange:je,saveBatch:$e,regExp:g,formRules:Ie,skuPriceRules:Ge,skuMarketPriceRules:Fe,skuCostPriceRules:Le,skuStockRules:qe,handleGoodsInit:Ee,save:Ve,back:Ze,filterSpecial:Me,handleBlur:He,attrOptions:B,attrChange:le,getAttrListFn:ae,attrTableData:k,addAttr:()=>{let e={attr_value_id:"",attr_value_name:"",child:{id:1,name:""},sort:"",type:"text",select_child_name:"",select_child_val:""};e.attr_value_id=-Math.floor(new Date().getSeconds()+Math.floor(new Date().getMilliseconds())),e.sort=k.length+1,k.push(e)},delAttr:e=>{k.splice(e,1)},attrRadioChange:(e,r)=>{k.forEach((s,t,a)=>(s.type=="radio"&&s.child.forEach((o,c)=>{o.id==r&&(a[t].select_child_name=o.id,a[t].select_child_val=o.name)}),s))},attrCheckboxChange:(e,r)=>{k[e].select_child_val=[],k[e].child.forEach((s,t)=>{r.indexOf(s.id)>-1&&k[e].select_child_val.push(s.name)})}}}export{gs as u};
